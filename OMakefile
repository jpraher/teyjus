.SUBDIRS: source

################################################
# Default target build programs and moves them to toplevel
#

OCamlProgramCopy(all, ., source/tjcc)
OCamlProgramCopy(all, ., source/tjsim)
OCamlProgramCopy(all, ., source/tjlink)
OCamlProgramCopy(all, ., source/tjdis)
OCamlProgramCopy(all, ., source/tjdepend)
.DEFAULT: all

################################################
# Distribution
#

# The dist target will package up teyjus into a tarball.

# Here are the main steps in building the tarball
#  1. Run all tests
#  2. Create a distribution directory
#  3. Confirm that 'omake all' works within that directory
#  4. Re-create the distribution directory
#  5. Set permissions and package up the distribution directory 

BuildDist() =
    rm -rf dist
    rm $(filter-proper-targets $(ls R, .))

    mkdir dist
    cp README dist/
    cp COPYING dist/
    cp OMakefile dist/
    cp OMakeroot dist/

    cp -r util dist/
    cp -r examples dist/
    cp -r source dist/
    cp -r emacs dist/
    rm -rf dist/source/test
    rm -rf $(find dist -name .svn)
    rm -f $(find dist -name *.omc)

teyjus.tar.gz: test
    BuildDist()
    cd dist && omake all
    BuildDist()
    rm -f teyjus.tar.gz
    mv dist teyjus
    bash -c "/usr/bin/find teyjus -type d | xargs chmod 755"
    bash -c "/usr/bin/find teyjus -type f | xargs chmod 644"
    tar c teyjus | gzip - > teyjus.tar.gz
    bash -c "chmod 664 teyjus.tar.gz"
    rm -rf teyjus

.PHONY: dist
dist: teyjus.tar.gz

################################################
# Utilites
#

.PHONY: clean
clean:
    rm $(filter-proper-targets $(ls R, .))
